<form action="" method="post">
<div class="selection-input">

  <div class="divider"> </div>


  <div class="selection-section">
    <button type="button" class="selection-section-btn">
        <span class="selection-arrow">&#9662;</span> 
        <i class="fa-solid fa-circle-dollar-to-slot fa-lg"></i>
        1. BUDGET 
    </button>
    <div class="selection-section-content" style="display: block;">

      <div id="budget-input" class="pref-input">

        <div id="budget-text" class="pref-text">
          Select Your Ideal Budget Below
        </div>

        <div id="budget-input-inner" class="pref-inner">
          <div class="slider-control">
            <div class="amount-display">$<span id="budget-amountValue">100</span></div>

            <button type="button" id="budget-decreaseBtn" class="decreaseBtn">−</button>
                
            <input type="range" name="budget_slider" id="budget-amountSlider" min="0" max="10000" value="100" step="50">
                
            <button type="button" id="budget-increaseBtn" class="increaseBtn">+</button>
          </div>
        </div>
      </div>

      <div class="selection-section-nav">                    
        <button type="button" class="selection-next">Next</button>
      </div>
      
    </div>
  </div>



  <div class="selection-section">
    <button type="button" class="selection-section-btn">
        <span class="selection-arrow">&#9662;</span> 
        <i class="fa-solid fa-passport fa-lg"></i> 
        2. PASSPORTS 
    </button>
    <div class="selection-section-content">
      
      <div id="passport-input" class="pref-input">

        <div id="passport-text" class="pref-text"> Select All Countries for Which You Hold a Valid Passport </div>

        <div id="passport-input-inner" class="pref-selects">
          <div id="passport-tag-selector" class="tag-selector">
            
            <select id="passport-tagDropdown" class="tag-dropdown">
              <option value="" disabled selected>Select a country</option>
              {% for country in countries %}
                <option value="{{ country.name }}">{{ country.name }}</option>
              {% endfor %}
            </select>

            <div id="passport-selectedTags" class="selectedTags"></div>
          </div>
          
        </div>
      </div>

      <div class="selection-section-nav">
        <button type="button" class="selection-back">Back</button>
                
        <button type="button" class="selection-next">Next</button>
      </div>

    </div>
  </div>




  <div class="selection-section">
    <button type="button" class="selection-section-btn">
        <span class="selection-arrow">&#9662;</span> 
        <i class="fa-solid fa-id-card fa-lg"></i>
        3. VISAS
    </button>
    <div class="selection-section-content">

      <div id="visa-input" class="pref-input">
        <div id="visa-text" class="pref-text"> Select All Countries for Which You Hold a Valid Visa </div>

        <div id="visa-input-inner" class="pref-selects">

          <div id="visa-tag-selector" class="tag-selector">
            <select id="visa-tagDropdown" class="tag-dropdown">
              <option value="" disabled selected>Select a country</option>
              {% for country in countries %}
                <option value="{{ country.name }}">{{ country.name }}</option>
              {% endfor %}
            </select>

            <div id="visa-selectedTags" class="selectedTags"></div>
          </div>

        </div>
      </div>

      <div class="selection-section-nav">
        <button type="button" class="selection-back">Back</button>
                
        <button type="button" class="selection-next">Next</button>
      </div>
      
    </div>
  </div>


  
  <div class="selection-section">
    <button type="button" class="selection-section-btn">
        <span class="selection-arrow">&#9662;</span> 
        <i class="fa-solid fa-icons fa-xl"></i>
        4. PREFERRED ACTIVITIES
    </button>
    <div class="selection-section-content" id="activities-content">
  
      {% for category in categories %}
      <div class="selection-section">
        <button type="button" class="selection-subsection-btn">
            <span class="selection-subarrow">&#9662;</span> 
            <i class="fa-solid fa-heart fa-lg"></i>
            {{ category.category_name | upper }} 
        </button>
        <div class="selection-subsection-content">

          {% set category_firstword = category.category_name.split(' ')[0] | lower %}

          <div id="{{ category_firstword }}-input" class="pref-input">
            <div id="{{ category_firstword }}-text" class="pref-text"> Select Your Preferred Activity Tags & Priorities Below</div>

            <div id="{{ category_firstword }}-input-inner" class="pref-selects">

              <div id="{{ category_firstword }}-tag-selector" class="tag-selector">
                <select id="{{ category_firstword }}-tagDropdown" class="tag-dropdown">
                  <option value="" disabled selected>Select a tag</option>
                  {% for activity in category.category_activities %}
                  <option value="{{ activity.name }}">{{ activity.name }}</option>
                  {% endfor %}
                </select>

                <div id="{{ category_firstword }}-selectedTags" class="selectedTags"></div>
              </div>      
              
              <div id="{{ category_firstword }}-slider-control" class="slider-control" style="display: none;">
                <div> <span class="priority-name" id="{{ category_firstword }}-priority-name"></span></div>
                <div class="amount-subdisplay"> <span id="{{ category_firstword }}-amountValue">0</span></div>

                <button type="button" id="{{ category_firstword }}-decreaseBtn" class="decreaseBtn">−</button>
                    
                <input type="range" name="{{ category_firstword }}_slider" id="{{ category_firstword }}-amountSlider" min="0" max="10" value="0" >
                    
                <button type="button" id="{{ category_firstword }}-increaseBtn" class="increaseBtn">+</button>

                <button type="button" id="{{ category_firstword }}-adjustBtn" class="adjustBtn">Save</button>
              </div>
            </div>
          </div>

          <div class="selection-section-nav">
            <button type="button" class="selection-back">Back</button>
                      
            <button type="button" class="selection-next">Next</button>
          </div>
          
        </div>
      </div>
      {% endfor %}


    </div>
  </div> 


  <div class="divider"> </div>  
  
 
  <div id="save-input" class="pref-input">
    <div id="save-input-inner" class="pref-inner">
      <button type = "submit" class="save">Save Changes</button>    
    </div>   
  </div>
  

</div>
</form>


{% block js %}   
  <script> 
    
    // Stores user's selected categories and activities with priorities
    const category_submit = [];

    // Stores the last clicked tag
    let clicked_tag = null;


    function find_category(slider_element) {

      let category_exists_check = category_submit.find(
        category => Object.values(category).find(category_value => category_value === slider_element.elementName) !== undefined
      );

      return category_exists_check;      
    }


    function find_activity(tag_name, activities) {

      let activity_exists_check = activities.find(
        activity => Object.values(activity).find(activity_value => activity_value === tag_name) !== undefined
      );

      return activity_exists_check;
    }


    // Handles storing selected activity and its priority per category
    function update_activity_submit(e, slider_el) {      

      let selected_tag_name = e.target.innerHTML.slice(0, e.target.innerHTML.indexOf(" <"));

      // Look for category
      let target_category = find_category(slider_el);

      //console.log(e.target);

      if (target_category !== undefined) {        
        // If category already exists, update or add new activity to it        
        
        let activities_list = target_category.categoryActivities;
        
        // Look for the activity in category
        let activity = find_activity(selected_tag_name, activities_list);
        
        if (activity !== undefined) {
          // If activity already exists, update activity priority

          // Update existing activity priority
          if (activity.activityName === selected_tag_name) {

            activity.activityPriority = slider_el.slider.value;

          }

        } else {
          // If activity does not exist, add new activity and priority

          // Push new activity into the category's activities list
          activities_list.push(
            {
              activityName: selected_tag_name,
              activityPriority: slider_el.slider.value
            }
          );

        }

      } else {
        // If category does not exist, add it io the list

        // First time this category is being selected
        category_submit.push(
          {
            categoryName: slider_el.elementName,
            categoryActivities: [
              {
                activityName: selected_tag_name,
                activityPriority: slider_el.slider.value
              }
            ]
          }
        );

      }

      console.log("Add category_submit: ");
      console.log(category_submit);
    }



    /* 
        <----------------------------------------------->
        <--------------- SLIDER ELEMENTS --------------->
        <----------------------------------------------->        
    */

    /* 
      This array holds all slider-related UI elements and settings 
      for budget and each dynamic category created from backend.
    */
    const slider_elements = [
      {
        // Base budget slider and controls
        elementName: "Budget",
        slider: document.getElementById("budget-amountSlider"),
        amountValue: document.getElementById("budget-amountValue"),
        increaseBtn: document.getElementById("budget-increaseBtn"),
        decreaseBtn: document.getElementById("budget-decreaseBtn"),
        stepValue: 50 // Budget slider increases in $50 increments
      }      
    ];

    // Dynamically generate slider elements for all categories using server-side template data
    {% for category in categories %}

      slider_elements.push(
        {
          elementName: "{{ category.category_name | escape }}",
          slider: document.getElementById("{{ category.category_name.split(' ')[0] | lower | escape }}-amountSlider"),
          amountValue: document.getElementById("{{ category.category_name.split(' ')[0] | lower | escape }}-amountValue"),
          increaseBtn: document.getElementById("{{ category.category_name.split(' ')[0] | lower | escape }}-increaseBtn"),
          decreaseBtn: document.getElementById("{{ category.category_name.split(' ')[0] | lower | escape }}-decreaseBtn"),
          adjustBtn: document.getElementById("{{ category.category_name.split(' ')[0] | lower | escape }}-adjustBtn"),
          stepValue: 1 // Category sliders increase in single units
        }
      );

    {% endfor %}


    // Update display value when slider is moved manually
    function set_pref_amt(el_slider, amt_val, display_val) {      
      display_val = parseInt(el_slider.value);
      amt_val.innerText = display_val;
    }

    // Increase slider value using plus button
    function increase_amt(el_slider, amt_val, add_val) { 
      let current_val = parseInt(amt_val.innerText);
      if (current_val < parseInt(el_slider.max)) {
        current_val += add_val;
      }
      el_slider.value = current_val;
      amt_val.innerText = current_val;
    }

    // Decrease slider value using minus button
    function decrease_amt(el_slider, amt_val, minus_val) { 
      let current_val = parseInt(amt_val.innerText);
      if (current_val > parseInt(el_slider.min)) {
        current_val -= minus_val;
      }
      el_slider.value = current_val;
      amt_val.innerText = current_val;
    }

    // Attach slider listeners to update UI and value on interaction
    slider_elements.forEach(element => {
      element.slider.addEventListener("input", () => {
        set_pref_amt(element.slider, element.amountValue);
      });

      element.increaseBtn.addEventListener("click", () => {
        increase_amt(element.slider, element.amountValue, element.stepValue);
      });

      element.decreaseBtn.addEventListener("click", () => {
        decrease_amt(element.slider, element.amountValue, element.stepValue);
      });
    });



    /* 
        <--------------------------------------------------->
        <----------------- DROPDOWN ELEMENTS --------------->
        <--------------------------------------------------->        
    */


    /*
      Manages dropdowns and tag selections for categories 
      and special elements like Visa and Passport.
    */

    // Initialize dropdowns for static and dynamic categories
    const dropdown_elements = [
      {
        elementName: "Visa",
        dropdown: document.getElementById('visa-tagDropdown'),
        selectedTagsContainer: document.getElementById('visa-selectedTags')
      },
      {
        elementName: "Passport",
        dropdown: document.getElementById('passport-tagDropdown'),
        selectedTagsContainer: document.getElementById('passport-selectedTags')
      }      
    ];

    // Dynamically push additional categories into dropdown array
    {% for category in categories %}

      dropdown_elements.push({
        elementName: "{{ category.category_name | escape }}",
        dropdown: document.getElementById("{{ category.category_name.split(' ')[0] | lower | escape }}-tagDropdown"),
        selectedTagsContainer: document.getElementById("{{ category.category_name.split(' ')[0] | lower | escape }}-selectedTags"),
        priorityName: document.getElementById("{{ category.category_name.split(' ')[0] | lower | escape }}-priority-name"),
        sliderDiv: document.getElementById("{{ category.category_name.split(' ')[0] | lower | escape }}-slider-control"),
        sliderElement: slider_elements.find(element => element.elementName === "{{ category.category_name | escape }}")
      });

    {% endfor %}

    // Create tag and add to UI when dropdown value is selected
    function populate_tags(el_dropdown, tags_container, priority_name, slider_div, slider_el) {  

      const value = el_dropdown.value;
      if (!value) return;

      // Prevent duplicate tags
      if (Array.from(tags_container.children).some(tag => tag.dataset.value === value)) return;

      // Create new tag UI element
      const tag = document.createElement('div');
      tag.classList.add('selection-tag');
      tag.dataset.value = value;
      tag.innerHTML = `${value} <span class="remove-tag"> &times; </span>`;      

      // Handle click to activate tag and show priority slider
      tag.addEventListener("click", function(e) {
        if (priority_name != null) {
          // Only one tag should be active per category
          // Check if any other tag in this container is active — and if so, don’t allow this new one to activate.
          if (Array.from(tags_container.children).some(child => child !== tag && child.classList.contains("active-tag"))) {
            return;
          } else {
            // set clicked event e for updating the categories and priorities
            clicked_tag = e;

            if (tag.classList.contains("active-tag")) {
              // Deselect tag
              tag.classList.remove("active-tag");
              slider_div.style.display = "none";
              slider_el.slider.value = 0;
              slider_el.amountValue.innerHTML = 0;

            } else {
              // Select tag and show slider UI
              tag.classList.add('active-tag');
              priority_name.innerHTML = 'Adjust "' + value + '" Priority:';
              slider_div.style.display = "flex";


              let selected_tag_name = e.target.innerHTML.slice(0, e.target.innerHTML.indexOf(" <"));

              // Look for category
              let target_category = find_category(slider_el);

              if (target_category !== undefined) {        
                // If category already exists, update or add new activity to it        
                
                let activities_list = target_category.categoryActivities;
                
                // Look for the activity in category
                let activity = find_activity(selected_tag_name, activities_list);
                
                if (activity !== undefined) {
                  // If activity already exists, update activity priority

                  // Update existing activity priority
                  if (activity.activityName === selected_tag_name) {           

                    slider_el.slider.value = activity.activityPriority;
                    slider_el.amountValue.innerHTML = activity.activityPriority;

                  }

                }

              }

            }
          }
        }
      });

      tags_container.appendChild(tag);      
    }

    // Removes tag when "×" is clicked
    function remove_tags(e, slider_div, slider_el) {    
      
      //remove that deleted tag from the category in the submit list
      //if a category has no tags, remove it from the list

      
        
      if (e.target.classList.contains('remove-tag')) {

        if (slider_div != null) {

          console.log(e.target.parentElement);

          let selected_tag_name = e.target.parentElement.innerHTML.slice(0, e.target.parentElement.innerHTML.indexOf(" <"));

          // Look for category
          let target_category = find_category(slider_el);

          console.log(target_category);

          if (target_category !== undefined) {     
            
            // If category already exists, update or add new activity to it        
            
            let activities_list = target_category.categoryActivities;
            
            // Look for the activity in category
            let activity = find_activity(selected_tag_name, activities_list);
            
            if (activity !== undefined) {
              // If activity already exists, update activity priority

              // Update existing activity priority
              if (activity.activityName === selected_tag_name) {           
                
                activities_list.splice(activities_list.indexOf(activity), 1);  // removes 1 item at that index
                
                slider_div.style.display = "none";

                console.log(activities_list);

                if (activities_list.length === 0) {
                  
                  category_submit.splice(category_submit.indexOf(target_category), 1); 

                }

              }

            }

          }

        }      

        e.target.parentElement.remove();

        console.log("Remove category_submit: ");
        console.log(category_submit);
      }

      
    }

    // Bind all dropdowns and tag containers to logic
    dropdown_elements.forEach(element => {
      if (element.priorityName != null) {
        // Category-based dropdowns
        element.dropdown.addEventListener('change', () => {
          populate_tags(element.dropdown, element.selectedTagsContainer, element.priorityName, element.sliderDiv, element.sliderElement);
        });

        // On "Adjust" button click, update the data structure
        element.sliderElement.adjustBtn.addEventListener("click", () => {
          update_activity_submit(clicked_tag, element.sliderElement);
        });

        element.selectedTagsContainer.addEventListener('click', (e) => {
          remove_tags(e, element.sliderDiv, element.sliderElement);
        });

      } else {
        // Static dropdowns like Visa/Passport
        element.dropdown.addEventListener('change', () => {
          populate_tags(element.dropdown, element.selectedTagsContainer, null, null, null);
        });

        element.selectedTagsContainer.addEventListener('click', (e) => {
          remove_tags(e, null, null);
        });
      }

      
    });


    /* 
        <---------------------------------------------------->
        <--------------- DROPDOWN NAVIGATION ---------------->
        <---------------------------------------------------->
        Collapsible UI sections for organizing categories or groups
    */

    const dropdownButtons = document.querySelectorAll('.selection-section-btn, .selection-subsection-btn');

    dropdownButtons.forEach(button => {
      button.addEventListener('click', function() {
        this.classList.toggle('active');

        const dropdownContent = this.nextElementSibling;
        const arrow = this.querySelector('.selection-arrow, .selection-subarrow');

        // Toggle the arrow and dropdown visibility
        if (dropdownContent.style.display === "block") {
          dropdownContent.style.display = "none";
          arrow.innerHTML = "&#9662;"; // down
        } else {
          dropdownContent.style.display = "block";
          arrow.innerHTML = "&#9652;"; // up
        }
      });
    });


    /*
      <------------------------------------------------------>
      <------------------- BACK/NEXT BUTTONS ---------------->
      <------------------------------------------------------>
      Not yet implemented: navigation logic between sections
      using "Back" and "Next" buttons.
    */

    // On click back: trigger click on previous dropdown button
    // On click next: trigger click on next dropdown button




  </script>

{% endblock%}